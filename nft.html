<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì¶ NFT Plans</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; background: #0f0f0f; color: #fff; margin: 0; padding: 20px; }
    h1, h2, h3 { text-align: center; }
    .balances, .active-info { text-align: center; margin: 15px 0; }
    .plan-container { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px; }
    .plan-section { width: 48%; }
    .plan { background: #1a1a1a; border: 2px solid #333; border-radius: 10px; padding: 15px; margin: 10px 0; text-align: center; }
    .plan button { padding: 10px 20px; margin-top: 10px; background: #00cc66; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .plan button:disabled { background: #555; cursor: not-allowed; }
    .active-label { color: #00ffcc; font-weight: bold; margin-top: 10px; }
    .cancel-button { background-color: #cc3300; margin-top: 10px; }
    @media screen and (max-width: 768px) { .plan-section { width: 100%; } }
  </style>
</head>
<body>
  <h1>ü™ô NFT Access Plans</h1>
  <p style="text-align:center;">Buy a plan using USDT or ZMM to activate missions and rewards.</p>
  
  <div class="balances">
    <div>üíµ USDT Balance: <span id="usdt-balance">0</span></div>
    <div>ü™ô ZMM Balance: <span id="zmm-balance">0</span></div>
  </div>

  <div class="active-info" id="active-plan-info">Loading your plan...</div>

  <div class="plan-container">
    <div class="plan-section" id="usdt-section"></div>
    <div class="plan-section" id="zmm-section"></div>
  </div>

<script>
  // üîê Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBN4LbA8udE4POVTR-XlZgpHQOvuNcSMI4",
    authDomain: "zmmssmk.firebaseapp.com",
    databaseURL: "https://zmmssmk-default-rtdb.firebaseio.com",
    projectId: "zmmssmk",
    storageBucket: "zmmssmk.appspot.com",
    messagingSenderId: "677420760492",
    appId: "1:677420760492:web:2c27c0f0ed6490b8dfce09"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function getUserId() {
    let uid = localStorage.getItem("uid");
    if (!uid) {
      uid = "user_" + Math.floor(Math.random() * 1000000);
      localStorage.setItem("uid", uid);
    }
    return uid;
  }

  const userId = getUserId();
  let wallet = { usdt: 0, zmm: 0 };
  let activePlans = { usdt: null, zmm: null };

  const PLAN_CONFIG = {
    usdt: [
      { amount: 10, duration: 30, videoReward: 2, dailyReward: 2 },
      { amount: 25, duration: 30, videoReward: 6, dailyReward: 4 },
      { amount: 50, duration: 30, videoReward: 10, dailyReward: 6 },
      { amount: 100, duration: 30, videoReward: 16, dailyReward: 12 },
      { amount: 500, duration: null, videoReward: 22, dailyReward: 20 },
    ],
    zmm: [
      { amount: 1000, duration: 30, videoReward: 2, dailyReward: 2 },
      { amount: 2500, duration: 30, videoReward: 6, dailyReward: 4 },
      { amount: 5000, duration: 30, videoReward: 10, dailyReward: 6 },
      { amount: 10000, duration: 30, videoReward: 16, dailyReward: 12 },
      { amount: 50000, duration: null, videoReward: 22, dailyReward: 20 },
    ]
  };

  function updateBalanceUI() {
    document.getElementById("usdt-balance").textContent = wallet.usdt.toFixed(2);
    document.getElementById("zmm-balance").textContent = wallet.zmm.toFixed(2);
  }

  function formatDaysLeft(dateString) {
    const now = new Date();
    const expires = new Date(dateString);
    const diffTime = expires - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays <= 0 ? "Expired" : `${diffDays} days left`;
  }

  function renderActivePlanInfo() {
    const infoDiv = document.getElementById("active-plan-info");
    let active = activePlans.usdt || activePlans.zmm;

    if (active && active.id) {
      const type = activePlans.usdt ? "USDT" : "ZMM";
      const plan = PLAN_CONFIG[type.toLowerCase()].find(p => `${type.toLowerCase()}-${p.amount}` === active.id);
      if (!plan) {
        infoDiv.textContent = "‚ö†Ô∏è Error loading active plan.";
        return;
      }
      const timeText = plan.duration ? formatDaysLeft(active.expiresAt) : "Lifetime";
      infoDiv.innerHTML = `‚úÖ Your Active Plan: <strong>${type} ${plan.amount}</strong> ‚Äì ${timeText}`;
    } else {
      infoDiv.innerHTML = `üÜì <strong>Free Plan Active</strong> ‚Äì Upgrade to earn more!`;
    }
  }

  function renderPlans() {
    ["usdt", "zmm"].forEach(type => {
      const container = document.getElementById(`${type}-section`);
      container.innerHTML = `<h2>${type === "usdt" ? "üíµ USDT Plans" : "ü™ô ZMM Token Plans"}</h2>`;

      PLAN_CONFIG[type].forEach(plan => {
        const planId = `${type}-${plan.amount}`;
        const div = document.createElement("div");
        div.className = "plan";

        div.innerHTML = `
          <h3>${type === "usdt" ? "$" + plan.amount : plan.amount + " ZMM"}</h3>
          <p>${plan.duration ? "1 Month Access" : "Lifetime Access"}</p>
          <p>üëâ Video Reward: ${plan.videoReward} tokens</p>
          <p>‚è∞ Every 4 Hours: ${plan.dailyReward} tokens</p>
        `;

        const active = activePlans[type];
        if (active && active.id === planId) {
          const label = document.createElement("div");
          label.className = "active-label";
          label.innerHTML = `‚úÖ Active<br>${plan.duration ? formatDaysLeft(active.expiresAt) : "Lifetime"}`;
          div.appendChild(label);

          if (plan.duration) {
            const cancel = document.createElement("button");
            cancel.className = "cancel-button";
            cancel.innerText = "Cancel";
            cancel.onclick = () => cancelPlan(type);
            div.appendChild(cancel);
          }
        } else {
          const button = document.createElement("button");
          button.innerText = wallet[type] >= plan.amount ? "Buy" : "Insufficient Balance";
          button.disabled = !!activePlans[type] || wallet[type] < plan.amount;
          button.onclick = () => buyPlan(type, plan.amount);
          div.appendChild(button);
        }

        container.appendChild(div);
      });
    });
  }

  async function fetchUserData() {
    const userRef = db.ref("users/" + userId);
    userRef.once("value").then(snapshot => {
      const data = snapshot.val();
      if (data) {
        wallet = typeof data.wallet === "object" ? data.wallet : wallet;
        activePlans = typeof data.activePlans === "object" ? data.activePlans : activePlans;
      } else {
        userRef.set({ wallet, activePlans });
      }
      updateBalanceUI();
      renderActivePlanInfo();
      renderPlans();
    }).catch(error => {
      console.error("‚ùå Firebase error:", error);
      document.getElementById("active-plan-info").textContent = "Error loading data.";
    });
  }

  async function buyPlan(type, amount) {
    const planId = `${type}-${amount}`;
    const plan = PLAN_CONFIG[type].find(p => p.amount === amount);
    if (!plan || wallet[type] < amount) return alert("‚ùå Not enough balance");

    const otherType = type === "usdt" ? "zmm" : "usdt";
    activePlans[otherType] = null;
    activePlans[type] = {
      id: planId,
      expiresAt: plan.duration ? new Date(Date.now() + plan.duration * 86400000).toISOString() : null
    };
    wallet[type] -= amount;

    await db.ref("users/" + userId).update({ wallet, activePlans });
    updateBalanceUI();
    renderActivePlanInfo();
    renderPlans();
    alert("‚úÖ Plan activated successfully!");
  }

  async function cancelPlan(type) {
    if (!confirm("Cancel this plan?")) return;
    activePlans[type] = null;
    await db.ref("users/" + userId + "/activePlans/" + type).remove();
    renderActivePlanInfo();
    renderPlans();
  }

  fetchUserData();
</script>
</body>
  </html>
