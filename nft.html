<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì¶ NFT Plans</title>

  <!-- Firebase Core -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    /* [Same CSS as before ‚Äì No Change] */
  </style>
</head>
<body>
  <h1>ü™ô NFT Access Plans</h1>
  <p style="text-align:center;">Buy a plan using USDT or ZMM to activate missions and rewards.</p>

  <div class="balances">
    <div>üíµ USDT Balance: <span id="usdt-dashboard">Loading...</span></div>
    <div>ü™ô ZMM Balance: <span id="zmm-dashboard">Loading...</span></div>
  </div>

  <div class="active-info" id="active-plan-info">Loading your plan...</div>

  <div class="plan-container">
    <div class="plan-section" id="usdt-section"></div>
    <div class="plan-section" id="zmm-section"></div>
  </div>

  <!-- [Info Section Same as Before] -->

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBN4LbA8udE4POVTR-XlZgpHQOvuNcSMI4",
  authDomain: "zmmssmk.firebaseapp.com",
  databaseURL: "https://zmmssmk-default-rtdb.firebaseio.com",
  projectId: "zmmssmk",
  storageBucket: "zmmssmk.appspot.com",
  messagingSenderId: "677420760492",
  appId: "1:677420760492:web:2c27c0f0ed6490b8dfce09"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let wallet = { usdt: 0, zmm: 0 };
let activePlans = { usdt: null, zmm: null };
let currentUserId = null;

const PLAN_CONFIG = {
  usdt: [
    { amount: 10, duration: 30, videoReward: 2, dailyReward: 2 },
    { amount: 25, duration: 30, videoReward: 6, dailyReward: 4 },
    { amount: 50, duration: 30, videoReward: 10, dailyReward: 6 },
    { amount: 100, duration: 30, videoReward: 16, dailyReward: 12 },
    { amount: 500, duration: null, videoReward: 22, dailyReward: 20 }
  ],
  zmm: [
    { amount: 1000, duration: 30, videoReward: 2, dailyReward: 2 },
    { amount: 2500, duration: 30, videoReward: 6, dailyReward: 4 },
    { amount: 5000, duration: 30, videoReward: 10, dailyReward: 6 },
    { amount: 10000, duration: 30, videoReward: 16, dailyReward: 12 },
    { amount: 50000, duration: null, videoReward: 22, dailyReward: 20 }
  ]
};

function updateBalanceUI() {
  document.getElementById("usdt-dashboard").textContent = "$" + wallet.usdt.toFixed(2);
  document.getElementById("zmm-dashboard").textContent = wallet.zmm.toFixed(2) + " ZMM";
}

function formatDaysLeft(dateString) {
  const now = new Date();
  const expires = new Date(dateString);
  const diff = expires - now;
  const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
  return days <= 0 ? "Expired" : `${days} days left`;
}

function renderActivePlanInfo() {
  const info = document.getElementById("active-plan-info");
  const active = activePlans.usdt || activePlans.zmm;
  if (active && active.id) {
    const type = activePlans.usdt ? "usdt" : "zmm";
    const plan = PLAN_CONFIG[type].find(p => `${type}-${p.amount}` === active.id);
    if (!plan) {
      info.textContent = "‚ö†Ô∏è Error loading active plan.";
      return;
    }
    if (plan.duration && new Date(active.expiresAt) < new Date()) {
      cancelPlan(type);
      return;
    }
    const time = plan.duration ? formatDaysLeft(active.expiresAt) : "Lifetime";
    info.innerHTML = `‚úÖ Your Active Plan: <strong>${type.toUpperCase()} ${plan.amount}</strong> ‚Äì ${time}`;
  } else {
    info.innerHTML = `üÜì <strong>Free Plan Active</strong> ‚Äì Upgrade to earn more!`;
  }
}

function renderPlans() {
  ["usdt", "zmm"].forEach(type => {
    const container = document.getElementById(`${type}-section`);
    container.innerHTML = `<h2>${type === "usdt" ? "üíµ USDT Plans" : "ü™ô ZMM Token Plans"}</h2>`;
    PLAN_CONFIG[type].forEach(plan => {
      const planId = `${type}-${plan.amount}`;
      const div = document.createElement("div");
      div.className = "plan";
      div.innerHTML = `
        <h3>${type === "usdt" ? "$" + plan.amount : plan.amount + " ZMM"}</h3>
        <p>${plan.duration ? "1 Month Access" : "Lifetime Access"}</p>
        <p>üëâ Video Reward: ${plan.videoReward}</p>
        <p>‚è∞ Every 4 Hours: ${plan.dailyReward}</p>
      `;
      const isActive = activePlans[type]?.id === planId;
      if (isActive) {
        div.innerHTML += `<div class="active-label">‚úÖ Active<br>${plan.duration ? formatDaysLeft(activePlans[type].expiresAt) : "Lifetime"}</div>`;
        if (plan.duration) {
          const cancelBtn = document.createElement("button");
          cancelBtn.className = "cancel-button";
          cancelBtn.textContent = "Cancel";
          cancelBtn.onclick = () => cancelPlan(type);
          div.appendChild(cancelBtn);
        }
      } else {
        const btn = document.createElement("button");
        btn.textContent = wallet[type] >= plan.amount ? "Buy" : "Insufficient Balance";
        btn.disabled = !!activePlans[type] || wallet[type] < plan.amount;
        btn.onclick = () => buyPlan(type, plan.amount);
        div.appendChild(btn);
      }
      container.appendChild(div);
    });
  });
}

async function fetchUserData(uid) {
  currentUserId = uid;

  db.ref("users/" + uid + "/wallet").on("value", snapshot => {
    const data = snapshot.val();
    wallet = {
      usdt: data?.usdt || 0,
      zmm: data?.zmm || 0
    };
    updateBalanceUI();
    renderPlans();
  });

  db.ref("activePlans/" + uid).on("value", snapshot => {
    const data = snapshot.val();
    activePlans = data || { usdt: null, zmm: null };
    renderActivePlanInfo();
    renderPlans();
  });
}

async function buyPlan(type, amount) {
  const plan = PLAN_CONFIG[type].find(p => p.amount === amount);
  if (!plan || wallet[type] < amount) return alert("‚ùå Not enough balance");

  if (activePlans[type] && !confirm("‚ö†Ô∏è You already have an active plan. Replace it?")) return;

  const planId = `${type}-${amount}`;
  const other = type === "usdt" ? "zmm" : "usdt";
  activePlans[other] = null;
  activePlans[type] = {
    id: planId,
    expiresAt: plan.duration ? new Date(Date.now() + plan.duration * 86400000).toISOString() : null
  };
  wallet[type] -= amount;

  try {
    await db.ref("users/" + currentUserId + "/wallet").set(wallet);
    await db.ref("activePlans/" + currentUserId).set(activePlans);
    updateBalanceUI();
    renderActivePlanInfo();
    renderPlans();
    alert("‚úÖ Plan activated successfully!");
  } catch (error) {
    alert("‚ùå Failed to activate plan. Try again.");
    console.error(error);
  }
}

async function cancelPlan(type) {
  if (!confirm("‚ùå Cancel this plan?")) return;
  activePlans[type] = null;
  await db.ref("activePlans/" + currentUserId + "/" + type).remove();
  renderActivePlanInfo();
  renderPlans();
}

auth.onAuthStateChanged(user => {
  if (user) {
    fetchUserData(user.uid);
  } else {
    alert("‚ö†Ô∏è Please log in first.");
    window.location.href = "login.html";
  }
});
</script>
</body>
</html>
