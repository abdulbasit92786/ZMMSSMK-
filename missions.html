<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Missions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="mission-container">
    <h1>ğŸ¯ Daily Missions</h1>
    <div style="background:#222;color:#fff;padding:12px;margin-bottom:15px;border-radius:8px;text-align:center;">
      <strong>ğŸ“¦ Active Plan:</strong> <span id="plan-name">-</span><br>
      <strong>ğŸ Reward/Task:</strong> <span id="plan-reward">-</span> ZMM Token(s)<br>
      <strong>ğŸ’° Total Earned:</strong> <span id="total-earned">0</span> ZMM
    </div>

    <!-- Tasks -->
    <div class="video-task" id="task1">
      <p>ğŸ“º Watch Video 1</p>
      <button onclick="startTask('https://youtu.be/9iBwP4TbFHg?si=-spUOeZHbBEkQRnD', 'task1')">â–¶ï¸ Watch</button>
      <button id="verify-task1" style="display:none;" onclick="verifyTask('task1')">âœ… Verify</button>
    </div>

    <div class="video-task" id="task2">
      <p>ğŸ“º Watch Video 2</p>
      <button onclick="startTask('https://youtu.be/BfTGQYxp0ec?si=zDE8CtMT12B3aEzz', 'task2')">â–¶ï¸ Watch</button>
      <button id="verify-task2" style="display:none;" onclick="verifyTask('task2')">âœ… Verify</button>
    </div>

    <div class="video-task" id="task3">
      <p>ğŸ“º Watch Video 3</p>
      <button onclick="startTask('https://youtu.be/N4fOamB7uec?si=4timJdDmBeTlZvNG', 'task3')">â–¶ï¸ Watch</button>
      <button id="verify-task3" style="display:none;" onclick="verifyTask('task3')">âœ… Verify</button>
    </div>

    <div class="video-task" id="task4">
      <p>ğŸ“º Watch Video 4</p>
      <button onclick="startTask('https://youtu.be/BAXgvXnaKB4?si=acuEFWXuZazv4rrB', 'task4')">â–¶ï¸ Watch</button>
      <button id="verify-task4" style="display:none;" onclick="verifyTask('task4')">âœ… Verify</button>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBN4LbA8udE4POVTR-XlZgpHQOvuNcSMI4",
      authDomain: "zmmssmk.firebaseapp.com",
      databaseURL: "https://zmmssmk-default-rtdb.firebaseio.com",
      projectId: "zmmssmk",
      storageBucket: "zmmssmk.appspot.com",
      messagingSenderId: "677420760492",
      appId: "1:677420760492:web:2c27c0f0ed6490b8dfce09"
    };
    firebase.initializeApp(firebaseConfig);

    const TASK_IDS = ['task1', 'task2', 'task3', 'task4'];
    const HIDE_DURATION_HOURS = 12;
    let currentTaskStart = {};
    let uid = null;

    function getUid() {
      const urlParams = new URLSearchParams(window.location.search);
      const uidFromUrl = urlParams.get('uid');
      if (uidFromUrl) return uidFromUrl;

      if (window.Telegram.WebApp.initDataUnsafe?.user?.id) {
        return String(window.Telegram.WebApp.initDataUnsafe.user.id);
      }

      alert("âŒ UID Ù†Û Ù…Ù„Ø§Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ø³Û’ Ù¹ÛŒÙ„ÛŒÚ¯Ø±Ø§Ù… WebApp Ú©Û’ Ø°Ø±ÛŒØ¹Û’ Ú©Ú¾ÙˆÙ„ÛŒÚºÛ”");
      throw new Error("UID missing");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        uid = getUid();
        await initializeUser();
        await loadPlanAndEarnings();
        await checkTaskVisibility();
      } catch (e) {
        console.error("Error:", e);
      }
    });

    async function initializeUser() {
      const ref = firebase.database().ref('users/' + uid);
      const snap = await ref.get();
      if (!snap.exists()) {
        await ref.set({
          total_earned: 0,
          dashboard_balance: 0,
          active_plan: "plan_free",
          missions_completed: {}
        });
      }
    }

    function getReward(planKey) {
      switch (planKey) {
        case "plan_premium": return 3;
        case "plan_pro": return 5;
        default: return 1;
      }
    }

    async function loadPlanAndEarnings() {
      const ref = firebase.database().ref('users/' + uid);
      const snap = await ref.get();
      if (!snap.exists()) return;

      const data = snap.val();
      const plan = data.active_plan || "plan_free";
      const reward = getReward(plan);
      document.getElementById("plan-name").textContent = plan.replace("plan_", "").toUpperCase();
      document.getElementById("plan-reward").textContent = reward;
      document.getElementById("total-earned").textContent = data.total_earned || 0;
    }

    function startTask(url, taskId) {
      currentTaskStart[taskId] = Date.now();
      window.open(url, "_blank");
      document.getElementById("verify-" + taskId).style.display = "inline-block";
    }

    async function verifyTask(taskId) {
      const now = Date.now();
      const start = currentTaskStart[taskId];
      if (!start || now - start < 30000) {
        alert("â³ ÙˆÛŒÚˆÛŒÙˆ Ú©Ù… Ø§Ø² Ú©Ù… 30 Ø³ÛŒÚ©Ù†Úˆ Ø¯ÛŒÚ©Ú¾ÛŒÚºÛ”");
        return;
      }

      const ref = firebase.database().ref('users/' + uid);
      const snap = await ref.get();
      if (!snap.exists()) return;

      const user = snap.val();
      const lastWatched = user.missions_completed?.[taskId]?.lastWatched || 0;
      if (now - lastWatched < HIDE_DURATION_HOURS * 3600000) {
        alert("â›” Ø§Ø³ Ù¹Ø§Ø³Ú© Ú©Ùˆ Ø¢Ù¾ Ù¾ÛÙ„Û’ ÛÛŒ Ù…Ú©Ù…Ù„ Ú©Ø± Ú†Ú©Û’ ÛÛŒÚºÛ”");
        return;
      }

      const reward = getReward(user.active_plan || "plan_free");

      const updatedMissions = {
        ...(user.missions_completed || {}),
        [taskId]: {
          completed: true,
          lastWatched: now
        }
      };

      const newTotal = (user.total_earned || 0) + reward;
      const newBalance = (user.dashboard_balance || 0) + reward;

      await ref.update({
        missions_completed: updatedMissions,
        total_earned: newTotal,
        dashboard_balance: newBalance
      });

      document.getElementById("verify-" + taskId).style.display = "none";
      document.getElementById(taskId).innerHTML = `<p>âœ… Ù…Ú©Ù…Ù„ ÛÙˆØ§! +${reward} ZMM Ø¢Ù¾ Ú©Û’ Ø¨ÛŒÙ„Ù†Ø³ Ù…ÛŒÚº Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯Ø¦Û’Û”</p>`;
      document.getElementById("total-earned").textContent = newTotal;
    }

    async function checkTaskVisibility() {
      const ref = firebase.database().ref('users/' + uid);
      const snap = await ref.get();
      if (!snap.exists()) return;

      const user = snap.val();
      const now = Date.now();

      TASK_IDS.forEach(taskId => {
        const last = user.missions_completed?.[taskId]?.lastWatched || 0;
        if (now - last < HIDE_DURATION_HOURS * 3600000) {
          document.getElementById(taskId).innerHTML = `<p>âœ… Already completed. Come back later.</p>`;
        }
      });
    }
  </script>
</body>
</html>
