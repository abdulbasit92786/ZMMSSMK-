<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“¦ NFT Plans</title>
  <!-- Firebase Core -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    /* (Ø¢Ù¾ Ú©Ø§ Ù…ÙˆØ¬ÙˆØ¯Û CSS ÛŒÛØ§Úº Ø±ÛÛ’ Ú¯Ø§ØŒ ÙˆÛŒØ³Ø§ ÛÛŒ) */
    /* omitted for brevity */
  </style>
</head>
<body>

  <h1>ğŸª™ NFT Access Plans</h1>
  <p>Buy a plan using USDT or ZMM to activate missions and rewards.</p>

  <div class="balances">
    <div>ğŸ’µ USDT Balance: <span id="usdt-dashboard">Loading...</span></div>
    <div>ğŸª™ ZMM Balance: <span id="zmm-dashboard">Loading...</span></div>
  </div>

  <div class="active-info" id="active-plan-info">Loading your plan...</div>

  <div class="plan-container">
    <div class="plan-section" id="usdt-section"></div>
    <div class="plan-section" id="zmm-section"></div>
  </div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBN4LbA8udE4POVTR-XlZgpHQOvuNcSMI4",
  authDomain: "zmmssmk.firebaseapp.com",
  databaseURL: "https://zmmssmk-default-rtdb.firebaseio.com",
  projectId: "zmmssmk",
  storageBucket: "zmmssmk.appspot.com",
  messagingSenderId: "677420760492",
  appId: "1:677420760492:web:2c27c0f0ed6490b8dfce09"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let wallet = { usdt: 0, zmm: 0 };
let activePlanId = "plan_free"; // Default free plan
let currentUserId = null;

const PLAN_CONFIG = {
  usdt: [
    { amount: 10, duration: 30, videoReward: 2, dailyReward: 2 },
    { amount: 25, duration: 30, videoReward: 6, dailyReward: 4 },
    { amount: 50, duration: 30, videoReward: 10, dailyReward: 6 },
    { amount: 100, duration: 30, videoReward: 16, dailyReward: 12 },
    { amount: 500, duration: null, videoReward: 22, dailyReward: 20 }
  ],
  zmm: [
    { amount: 1000, duration: 30, videoReward: 2, dailyReward: 2 },
    { amount: 2500, duration: 30, videoReward: 6, dailyReward: 4 },
    { amount: 5000, duration: 30, videoReward: 10, dailyReward: 6 },
    { amount: 10000, duration: 30, videoReward: 16, dailyReward: 12 },
    { amount: 50000, duration: null, videoReward: 22, dailyReward: 20 }
  ]
};

function updateBalanceUI() {
  document.getElementById("usdt-dashboard").textContent = "$" + wallet.usdt.toFixed(2);
  document.getElementById("zmm-dashboard").textContent = wallet.zmm.toFixed(2) + " ZMM";
}

function parseActivePlan() {
  // Ø§Ú¯Ø± ÙØ±ÛŒ Ù¾Ù„Ø§Ù† ÛÙˆ ØªÙˆ Ø¯Ú©Ú¾Ø§Ø¦ÛŒÚº ÙˆØ±Ù†Û Ù¾Ù„Ø§Ù† Ú©ÛŒ ØªÙØµÛŒÙ„ Ù†Ú©Ø§Ù„ÛŒÚº
  if (!activePlanId || activePlanId === "plan_free") {
    return { type: null, amount: null };
  }
  // activePlanId Ú©ÛŒ Ø´Ú©Ù„ ÛÙˆÚ¯ÛŒ: "usdt-10" ÛŒØ§ "zmm-1000"
  const parts = activePlanId.split("-");
  if (parts.length !== 2) return { type: null, amount: null };
  return { type: parts[0], amount: Number(parts[1]) };
}

function renderActivePlanInfo() {
  const info = document.getElementById("active-plan-info");
  const { type, amount } = parseActivePlan();

  if (!type || !amount) {
    info.innerHTML = `ğŸ†“ <strong>Free Plan Active</strong> â€“ Upgrade to earn more!`;
    return;
  }

  const plan = PLAN_CONFIG[type]?.find(p => p.amount === amount);
  if (!plan) {
    info.textContent = "âš ï¸ Error loading active plan.";
    return;
  }

  const time = plan.duration ? `${plan.duration} days access` : "Lifetime Access";
  info.innerHTML = `âœ… Your Active Plan: <strong>${type.toUpperCase()} ${amount}</strong> â€“ ${time}`;
}

function renderPlans() {
  ["usdt", "zmm"].forEach(type => {
    const container = document.getElementById(`${type}-section`);
    container.innerHTML = `<h2>${type === "usdt" ? "ğŸ’µ USDT Plans" : "ğŸª™ ZMM Token Plans"}</h2>`;

    PLAN_CONFIG[type].forEach(plan => {
      const planId = `${type}-${plan.amount}`;
      const div = document.createElement("div");
      div.className = "plan";
      div.innerHTML = `
        <h3>${type === "usdt" ? "$" + plan.amount : plan.amount + " ZMM"}</h3>
        <p>${plan.duration ? "1 Month Access" : "Lifetime Access"}</p>
        <p>ğŸ¥ Video Reward: ${plan.videoReward}</p>
        <p>â° Every 4 Hours: ${plan.dailyReward}</p>
      `;

      const isActive = activePlanId === planId;

      if (isActive) {
        div.innerHTML += `<div class="active-label">âœ… Active</div>`;
        // Ø§Ú¯Ø± Ø¢Ù¾ cancel Ú©Ø§ Ø¢Ù¾Ø´Ù† Ø¯ÛŒÙ†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚº ØªÙˆ ÛŒÛØ§Úº Ú©ÙˆÚˆ Ø±Ú©Ú¾ Ø³Ú©ØªÛ’ ÛÛŒÚº
      } else {
        const btn = document.createElement("button");
        btn.textContent = wallet[type] >= plan.amount ? "Buy" : "Insufficient Balance";
        btn.disabled = activePlanId !== "plan_free" || wallet[type] < plan.amount;
        btn.onclick = () => buyPlan(type, plan.amount);
        div.appendChild(btn);
      }
      container.appendChild(div);
    });
  });
}

async function fetchUserData(uid) {
  currentUserId = uid;

  // Wallet
  db.ref("users/" + uid + "/wallet").on("value", snapshot => {
    const data = snapshot.val();
    wallet = {
      usdt: data?.usdt || 0,
      zmm: data?.zmm || 0
    };
    updateBalanceUI();
    renderPlans();
  });

  // Active Plan from users/{uid}/active_plan
  db.ref("users/" + uid + "/active_plan").on("value", snapshot => {
    const plan = snapshot.val();
    activePlanId = plan || "plan_free";
    renderActivePlanInfo();
    renderPlans();
  });
}

async function buyPlan(type, amount) {
  const planId = `${type}-${amount}`;

  if (activePlanId !== "plan_free" && activePlanId !== null) {
    if (!confirm("âš ï¸ You already have an active plan. Replace it?")) return;
  }

  if (wallet[type] < amount) {
    alert("âŒ Not enough balance");
    return;
  }

  // Deduct wallet amount
  wallet[type] -= amount;

  try {
    // Update wallet and active_plan atomically
    await db.ref("users/" + currentUserId + "/wallet").set(wallet);
    await db.ref("users/" + currentUserId + "/active_plan").set(planId);

    activePlanId = planId;
    updateBalanceUI();
    renderActivePlanInfo();
    renderPlans();
    alert("âœ… Plan activated successfully!");
  } catch (error) {
    alert("âŒ Failed to activate plan. Try again.");
    console.error(error);
  }
}

auth.onAuthStateChanged(user => {
  if (user) {
    fetchUserData(user.uid);
  } else {
    alert("âš ï¸ Please log in first.");
    window.location.href = "login.html";
  }
});
</script>

</body>
  </html>
