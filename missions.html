<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Missions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <!-- âœ… Firebase SDKs -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>
<body>
  <div class="mission-container">
    <h1>ğŸ¯ Daily Missions</h1>

    <div style="background:#222;color:#fff;padding:12px;margin-bottom:15px;border-radius:8px;text-align:center;">
      <strong>ğŸ“¦ Your Active Plan:</strong> <span id="plan-name">-</span><br>
      <strong>ğŸ Reward per Task:</strong> <span id="plan-reward">-</span> Token(s)
    </div>

    <div class="video-task" id="task1">
      <p>ğŸ“º Watch Video 1 (30 sec)</p>
      <button onclick="startTask('https://youtu.be/9iBwP4TbFHg?si=-spUOeZHbBEkQRnD', 'task1')">â–¶ï¸ Watch</button>
      <button id="verify-task1" onclick="verifyTask('task1')">âœ… Verify</button>
      <div class="status" id="status-task1">â³ Not Verified</div>
    </div>

    <div class="video-task" id="task2">
      <p>ğŸ“º Watch Video 2 (30 sec)</p>
      <button onclick="startTask('https://youtu.be/BfTGQYxp0ec?si=zDE8CtMT12B3aEzz', 'task2')">â–¶ï¸ Watch</button>
      <button id="verify-task2" onclick="verifyTask('task2')">âœ… Verify</button>
      <div class="status" id="status-task2">â³ Not Verified</div>
    </div>

    <div class="video-task" id="task3">
      <p>ğŸ“º Watch Video 3 (30 sec)</p>
      <button onclick="startTask('https://youtu.be/N4fOamB7uec?si=4timJdDmBeTlZvNG', 'task3')">â–¶ï¸ Watch</button>
      <button id="verify-task3" onclick="verifyTask('task3')">âœ… Verify</button>
      <div class="status" id="status-task3">â³ Not Verified</div>
    </div>

    <div class="video-task" id="task4">
      <p>ğŸ“º Watch Video 4 (30 sec)</p>
      <button onclick="startTask('https://youtu.be/BAXgvXnaKB4?si=acuEFWXuZazv4rrB', 'task4')">â–¶ï¸ Watch</button>
      <button id="verify-task4" onclick="verifyTask('task4')">âœ… Verify</button>
      <div class="status" id="status-task4">â³ Not Verified</div>
    </div>
  </div>

  <script>
    // âœ… Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBN4LbA8udE4POVTR-XlZgpHQOvuNcSMI4",
      authDomain: "zmmssmk.firebaseapp.com",
      databaseURL: "https://zmmssmk-default-rtdb.firebaseio.com",
      projectId: "zmmssmk",
      storageBucket: "zmmssmk.appspot.com",
      messagingSenderId: "677420760492",
      appId: "1:677420760492:web:2c27c0f0ed6490b8dfce09"
    };

    // âœ… Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const userId = localStorage.getItem("telegram_user_id") || "guest_user";

    // âœ… Load user's plan from database
    firebase.database().ref("users/" + userId).once("value").then((snapshot) => {
      const userData = snapshot.val();
      if (userData && userData.plan) {
        document.getElementById("plan-name").innerText = userData.plan;
        document.getElementById("plan-reward").innerText = userData.reward || 1;
      } else {
        document.getElementById("plan-name").innerText = "Free";
        document.getElementById("plan-reward").innerText = 1;
      }
    });

    function startTask(url, taskId) {
      window.open(url, "_blank");
    }

    function verifyTask(taskId) {
      const statusEl = document.getElementById("status-" + taskId);
      const rewardPerTask = parseInt(document.getElementById("plan-reward").innerText) || 1;

      // âœ… Update task status on UI
      statusEl.innerText = "âœ… Verified";

      // âœ… Save to Firebase under completedTasks
      const taskRef = database.ref("tasksCompleted/" + userId + "/" + taskId);
      taskRef.set({
        verified: true,
        timestamp: Date.now()
      });

      // âœ… Update user balance
      const userRef = database.ref("users/" + userId);
      userRef.once("value").then(snapshot => {
        const userData = snapshot.val();
        const currentBalance = (userData && userData.balance) ? userData.balance : 0;
        const newBalance = currentBalance + rewardPerTask;
        userRef.update({ balance: newBalance });

        // Optional: Update localStorage if you're using it
        localStorage.setItem("user_balance", newBalance);
      });
    }
  </script>
</body>
  </html>
