<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wallet</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container wallet-container">
    <h2>💼 My Wallet</h2>
    <div class="balances-grid">
      <div class="balance-card">
        <h3>💵 USDT</h3>
        <p id="usdt-balance">$0.00</p>
      </div>
      <div class="balance-card">
        <h3>🪙 ZMM</h3>
        <p id="zmm-balance">0 Tokens</p>
      </div>
    </div>

    <div class="swap-section">
      <h3>🔁 Swap Tokens</h3>
      <select id="swap-direction">
        <option value="zmm-to-usdt">ZMM → USDT</option>
        <option value="usdt-to-zmm">USDT → ZMM</option>
      </select>
      <input type="number" id="swap-amount" placeholder="Enter amount">
      <p id="conversion-result">🚱 Rate: 1 ZMM = -</p>
      <p id="calculated-output">You will receive: -</p>
      <button onclick="performSwap()">Swap Now</button>
    </div>

    <div class="action-buttons">
      <button onclick="window.location.href='withdraw.html'">🛄 Withdraw</button>
      <button onclick="window.location.href='deposit.html'">🛅 Deposit</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBN4LbA8udE4POVTR-XlZgpHQOvuNcSMI4",
      authDomain: "zmmssmk.firebaseapp.com",
      databaseURL: "https://zmmssmk-default-rtdb.firebaseio.com",
      projectId: "zmmssmk",
      storageBucket: "zmmssmk.appspot.com",
      messagingSenderId: "677420760492",
      appId: "1:677420760492:web:2c27c0f0ed6490b8dfce09"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const MIN_SWAP_USDT = 5;
    const MIN_SWAP_ZMM = 100;
    let ZMM_RATE = 0.05;
    let currentUid = null;

    function getZmmRate(plan) {
      return (plan === "nft100" || plan === "nft500") ? 0.01 : 0.05;
    }

    function updateWalletUI(usdt, zmm) {
      document.getElementById("usdt-balance").innerText = `$${parseFloat(usdt).toFixed(2)}`;
      document.getElementById("zmm-balance").innerText = `${parseFloat(zmm).toFixed(2)} Tokens`;
    }

    function updateRateLabel() {
      document.getElementById("conversion-result").innerText = `🚱 Rate: 1 ZMM = $${ZMM_RATE.toFixed(2)} USDT`;
      document.getElementById("swap-amount").dispatchEvent(new Event("input"));
    }

    function syncWallet() {
      if (!currentUid) return;

      const userRef = db.ref("users/" + currentUid);
      userRef.once("value").then(snapshot => {
        if (!snapshot.exists()) {
          alert("❌ User not found in database.");
          return;
        }
        const userData = snapshot.val();
        const wallet = userData.wallet || { usdt: 0, zmm: 0 };
        const plan = userData.activePlan || "free";

        updateWalletUI(wallet.usdt, wallet.zmm);
        ZMM_RATE = getZmmRate(plan);
        updateRateLabel();
      });

      db.ref("users/" + currentUid + "/wallet").on("value", snapshot => {
        const wallet = snapshot.val() || { usdt: 0, zmm: 0 };
        updateWalletUI(wallet.usdt, wallet.zmm);
      });
    }

    function performSwap() {
      const direction = document.getElementById("swap-direction").value;
      const amount = parseFloat(document.getElementById("swap-amount").value);
      if (isNaN(amount) || amount <= 0) return alert("❌ Enter a valid amount.");

      const walletRef = db.ref("users/" + currentUid + "/wallet");

      walletRef.once("value").then(snapshot => {
        let wallet = snapshot.val() || { usdt: 0, zmm: 0 };
        let zmm = parseFloat(wallet.zmm);
        let usdt = parseFloat(wallet.usdt);

        if (direction === "zmm-to-usdt") {
          if (amount < MIN_SWAP_ZMM || zmm < amount) return alert("❌ Not enough ZMM.");
          zmm -= amount;
          usdt += amount * ZMM_RATE;
        } else {
          if (amount < MIN_SWAP_USDT || usdt < amount) return alert("❌ Not enough USDT.");
          usdt -= amount;
          zmm += amount / ZMM_RATE;
        }

        walletRef.set({ usdt: usdt, zmm: zmm });
        alert("✅ Swap successful!");
      });
    }

    document.getElementById("swap-amount").addEventListener("input", () => {
      const direction = document.getElementById("swap-direction").value;
      const amount = parseFloat(document.getElementById("swap-amount").value);
      const output = document.getElementById("calculated-output");

      if (isNaN(amount) || amount <= 0) {
        output.innerText = "You will receive: -";
        return;
      }

      if (direction === "zmm-to-usdt") {
        output.innerText = `You will receive: $${(amount * ZMM_RATE).toFixed(2)} USDT`;
      } else {
        output.innerText = `You will receive: ${(amount / ZMM_RATE).toFixed(2)} ZMM`;
      }
    });

    document.getElementById("swap-direction").addEventListener("change", () => {
      document.getElementById("swap-amount").dispatchEvent(new Event("input"));
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUid = user.uid;
        syncWallet();
      } else {
        window.location.href = "login.html";
      }
    });
  </script>
</body>
          </html>
